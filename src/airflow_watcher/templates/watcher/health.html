{% extends "airflow/main.html" %}

{% block title %}DAG Health{% endblock %}

{% block head_css %}
{{ super() }}
<style>
    .watcher-page {
        padding: 20px;
    }
    .health-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    .health-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .health-card.healthy {
        border-top: 4px solid #4caf50;
    }
    .health-card.unhealthy {
        border-top: 4px solid #d32f2f;
    }
    .health-card.running {
        border-top: 4px solid #2196f3;
    }
    .health-card.unknown {
        border-top: 4px solid #9e9e9e;
    }
    .health-card .count {
        font-size: 3em;
        font-weight: bold;
    }
    .health-card.healthy .count { color: #4caf50; }
    .health-card.unhealthy .count { color: #d32f2f; }
    .health-card.running .count { color: #2196f3; }
    .health-card.unknown .count { color: #9e9e9e; }
    .health-card .label {
        color: #666;
        font-size: 1.1em;
        margin-top: 5px;
    }
    .dag-list-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dag-list-section h2 {
        margin-top: 0;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }
    .dag-list-section h2.healthy { color: #4caf50; }
    .dag-list-section h2.unhealthy { color: #d32f2f; }
    .dag-list-section h2.running { color: #2196f3; }
    .dag-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    .dag-item {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .dag-item:hover {
        background: #f0f0f0;
    }
    .dag-link {
        color: #1976d2;
        text-decoration: none;
        font-weight: 500;
    }
    .dag-link:hover {
        text-decoration: underline;
    }
    .dag-meta {
        color: #888;
        font-size: 0.85em;
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 500;
    }
    .badge-success { background: #e8f5e9; color: #2e7d32; }
    .badge-danger { background: #ffebee; color: #d32f2f; }
    .badge-info { background: #e3f2fd; color: #1565c0; }
    @media (max-width: 768px) {
        .health-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="watcher-page">
    <h1>üè• DAG Health Status</h1>
    
    <!-- Health Summary -->
    <div class="health-summary">
        <div class="health-card healthy">
            <div class="count">{{ health_status.summary.healthy_count }}</div>
            <div class="label">‚úÖ Healthy</div>
        </div>
        <div class="health-card unhealthy">
            <div class="count">{{ health_status.summary.unhealthy_count }}</div>
            <div class="label">‚ùå Unhealthy</div>
        </div>
        <div class="health-card running">
            <div class="count">{{ health_status.summary.running_count }}</div>
            <div class="label">üîÑ Running</div>
        </div>
        <div class="health-card unknown">
            <div class="count">{{ health_status.summary.unknown_count }}</div>
            <div class="label">‚ùì Unknown</div>
        </div>
    </div>

    <!-- Unhealthy DAGs -->
    {% if health_status.unhealthy %}
    <div class="dag-list-section">
        <h2 class="unhealthy">‚ùå Unhealthy DAGs ({{ health_status.unhealthy|length }})</h2>
        <div class="dag-grid">
            {% for dag in health_status.unhealthy %}
            <div class="dag-item">
                <div>
                    <a href="{{ url_for('Airflow.graph', dag_id=dag.dag_id) }}" class="dag-link">
                        {{ dag.dag_id }}
                    </a>
                    <div class="dag-meta">Last run: {{ dag.last_run or 'N/A' }}</div>
                </div>
                <span class="badge badge-danger">{{ dag.state }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Running DAGs -->
    {% if health_status.running %}
    <div class="dag-list-section">
        <h2 class="running">üîÑ Running DAGs ({{ health_status.running|length }})</h2>
        <div class="dag-grid">
            {% for dag in health_status.running %}
            <div class="dag-item">
                <div>
                    <a href="{{ url_for('Airflow.graph', dag_id=dag.dag_id) }}" class="dag-link">
                        {{ dag.dag_id }}
                    </a>
                    <div class="dag-meta">Started: {{ dag.last_run or 'N/A' }}</div>
                </div>
                <span class="badge badge-info">{{ dag.state }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Healthy DAGs -->
    {% if health_status.healthy %}
    <div class="dag-list-section">
        <h2 class="healthy">‚úÖ Healthy DAGs ({{ health_status.healthy|length }})</h2>
        <div class="dag-grid">
            {% for dag in health_status.healthy[:20] %}
            <div class="dag-item">
                <div>
                    <a href="{{ url_for('Airflow.graph', dag_id=dag.dag_id) }}" class="dag-link">
                        {{ dag.dag_id }}
                    </a>
                    <div class="dag-meta">Last run: {{ dag.last_run or 'N/A' }}</div>
                </div>
                <span class="badge badge-success">{{ dag.state }}</span>
            </div>
            {% endfor %}
            {% if health_status.healthy|length > 20 %}
            <div class="dag-item" style="justify-content: center;">
                <em>...and {{ health_status.healthy|length - 20 }} more healthy DAGs</em>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
